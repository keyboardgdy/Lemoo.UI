# Lemoo.UI 主题系统一致性分析与开发规范

## 一、主题系统架构概述

### 1.1 设计理念

Lemoo.UI 采用 **VS Code 风格的三层主题架构**，实现样式与主题的完全解耦：

```
┌─────────────────────────────────────────────────────────────┐
│                    设计系统层 (Styles/Design)                │
│  - Typography (字体)  - Spacing (间距)                      │
│  - Shadows (阴影)    - Animations (动画)                    │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  与主题无关的常量，所有主题共享                              │
├─────────────────────────────────────────────────────────────┤
│                    控件样式层 (Styles/Win11)                 │
│  - Win11.Button    - Win11.TextBox                          │
│  - Win11.CheckBox  - Win11.ComboBox                         │
│  - ...所有控件样式                                            │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│  使用 DynamicResource 引用主题资源                          │
├─────────────────────────────────────────────────────────────┤
│                    主题系统层 (Themes)                       │
│  ┌─────────────┐  ┌───────────────┐  ┌──────────────────┐  │
│  │ColorPalette │→ │SemanticTokens │→ │ComponentBrushes │  │
│  │ (调色板)     │  │  (语义令牌)    │  │  (组件画刷)      │  │
│  └─────────────┘  └───────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心文件

| 文件 | 职责 | 主题依赖 |
|------|------|----------|
| `ThemeManager.cs` | 主题管理器（核心） | - |
| `CommonStyles.xaml` | 样式系统入口 | 加载设计系统+控件样式 |
| `Base/ComponentBrushes.xaml` | 组件画刷定义 | 依赖语义令牌和调色板 |
| `Base/SemanticTokens.xaml` | 语义令牌定义 | 与调色板解耦 |
| `Base/ColorPalette.xaml` | 调色板定义 | 独立颜色值 |
| `Win11/*.xaml` | 控件样式 | 通过 DynamicResource 引用画刷 |

---

## 二、主题系统一致性分析

### 2.1 现有主题清单

```
Themes/
├── Base/           (原色模式 - 默认主题)
├── Dark/           (VS Dark 风格)
├── Light/          (VS Light 风格)
├── NeonCyberpunk/  (霓虹赛博朋克)
├── Aurora/         (极光)
├── SunsetTropics/  (热带夕阳)
├── RoseQuartz/     (玫瑰石英)
├── DeepOcean/      (深海幽蓝)
├── Sakura/         (樱花幻梦)
├── MidnightVelvet/ (午夜丝绒)
└── ForestWhisper/  (森林低语)
```

### 2.2 一致性检查清单

#### 2.2.1 文件结构一致性

每个主题**必须**包含以下文件：

```xml
Themes/[ThemeName]/
├── [ThemeName].xaml           <!-- 主题入口文件 -->
├── ColorPalette.xaml          <!-- 调色板（可选，继承 Base） -->
├── SemanticTokens.xaml        <!-- 语义令牌（必须） -->
└── ComponentBrushes.xaml      <!-- 组件画刷（可选，继承 Base） -->
```

#### 2.2.2 语义令牌完整性

所有主题的 `SemanticTokens.xaml` **必须**定义以下语义令牌：

| 分类 | 令牌键名 | 说明 |
|------|----------|------|
| **工作台** | `workbench.background` | 主背景色 |
| | `workbench.surface` | 次级表面 |
| | `workbench.card` | 卡片背景 |
| **标题栏** | `titleBar.background` | 标题栏背景 |
| | `titleBar.foreground` | 标题栏文字 |
| | `titleBar.activeBackground` | 激活状态背景 |
| | `titleBar.border` | 标题栏边框 |
| **侧边栏** | `sidebar.background` | 侧边栏背景 |
| | `sidebar.foreground` | 侧边栏文字 |
| | `sidebar.hoverBackground` | 悬停背景 |
| | `sidebar.selectedBackground` | 选中背景 |
| | `sidebar.selectedForeground` | 选中文字 |
| | `sidebar.border` | 侧边栏边框 |
| **按钮** | `button.background` | 按钮背景 |
| | `button.foreground` | 按钮文字 |
| | `button.hoverBackground` | 悬停背景 |
| | `button.pressedBackground` | 按下背景 |
| | `button.disabledBackground` | 禁用背景 |
| | `button.disabledForeground` | 禁用文字 |
| | `button.border` | 按钮边框 |
| **输入框** | `input.background` | 输入框背景 |
| | `input.foreground` | 输入框文字 |
| | `input.border` | 输入框边框 |
| | `input.focusBorder` | 聚焦边框 |
| | `input.placeholder` | 占位符颜色 |
| **卡片** | `card.background` | 卡片背景 |
| | `card.border` | 卡片边框 |
| | `card.hoverBackground` | 卡片悬停 |
| **文本** | `text.primary` | 主要文本 |
| | `text.secondary` | 次要文本 |
| | `text.disabled` | 禁用文本 |
| | `text.onDark` | 深色背景文本 |
| **边框** | `border.default` | 默认边框 |
| | `border.focus` | 聚焦边框 |
| **开关** | `toggleSwitch.offBackground` | 关闭状态背景 |
| | `toggleSwitch.offBorder` | 关闭状态边框 |
| | `toggleSwitch.onBackground` | 开启状态背景 |
| | `toggleSwitch.onBorder` | 开启状态边框 |
| | `toggleSwitch.knob` | 滑块颜色 |
| | `toggleSwitch.knobOn` | 开启滑块颜色 |
| **语义色** | `semantic.success.background` | 成功背景 |
| | `semantic.success.foreground` | 成功文字 |
| | `semantic.warning.background` | 警告背景 |
| | `semantic.warning.foreground` | 警告文字 |
| | `semantic.error.background` | 错误背景 |
| | `semantic.error.foreground` | 错误文字 |
| | `semantic.info.background` | 信息背景 |
| | `semantic.info.foreground` | 信息文字 |

#### 2.2.3 组件画刷命名规范

所有 `ComponentBrushes.xaml` 中的画刷**必须**遵循以下命名：

```xml
<!-- 完整名称 (推荐用于新控件) -->
<SolidColorBrush x:Key="ButtonBackgroundBrush" Color="{DynamicResource button.background}"/>
<SolidColorBrush x:Key="ButtonForegroundBrush" Color="{DynamicResource button.foreground}"/>

<!-- 简化名称 (兼容性保留) -->
<SolidColorBrush x:Key="Brush.Button.Background" Color="{DynamicResource button.background}"/>
<SolidColorBrush x:Key="Brush.Button.Foreground" Color="{DynamicResource button.foreground}"/>
```

**关键规则：**
1. 画刷的 `Color` 必须使用 `{DynamicResource}` 引用语义令牌
2. 禁止使用 `{StaticResource}` 引用可变颜色
3. 画刷名称使用 PascalCase 命名

---

## 三、确保主题兼容的开发规范

### 3.1 控件样式开发规范

#### 3.1.1 使用 DynamicResource

**✅ 正确示例：**

```xml
<Style TargetType="Button">
    <Setter Property="Background" Value="{DynamicResource ButtonBackgroundBrush}"/>
    <Setter Property="Foreground" Value="{DynamicResource ButtonForegroundBrush}"/>
    <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
</Style>
```

**❌ 错误示例：**

```xml
<!-- 使用 StaticResource 会导致主题切换不生效 -->
<Style TargetType="Button">
    <Setter Property="Background" Value="{StaticResource ButtonBackgroundBrush}"/>
</Style>

<!-- 直接使用硬编码颜色会导致所有主题一致 -->
<Style TargetType="Button">
    <Setter Property="Background" Value="#FF0000"/>
</Style>
```

#### 3.1.2 控件模板中的画刷引用

**✅ 正确示例：**

```xml
<ControlTemplate TargetType="Button">
    <Border x:Name="border"
            Background="{TemplateBinding Background}"
            BorderBrush="{TemplateBinding BorderBrush}"
            BorderThickness="{TemplateBinding BorderThickness}">
        <!-- ... -->
    </Border>
    <ControlTemplate.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
            <!-- 使用 Setter 直接设置，确保主题切换生效 -->
            <Setter TargetName="border"
                    Property="Background"
                    Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
        </Trigger>
    </ControlTemplate.Triggers>
</ControlTemplate>
```

**❌ 错误示例：**

```xml
<!-- 使用 Storyboard 中的 ColorAnimation 会导致主题切换不生效 -->
<ControlTemplate.Triggers>
    <Trigger Property="IsMouseOver" Value="True">
        <Trigger.EnterActions>
            <BeginStoryboard>
                <Storyboard>
                    <ColorAnimation Storyboard.TargetName="border"
                                   Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                   To="#FF333333"/>
                </Storyboard>
            </BeginStoryboard>
        </Trigger.EnterActions>
    </Trigger>
</ControlTemplate.Triggers>
```

#### 3.1.3 动画使用规范

**允许的动画类型：**
- ✅ `DoubleAnimation`（缩放、透明度、位移等）
- ✅ `PointAnimation`（路径动画）
- ✅ `ObjectAnimationUsingKeyFrames`（对象切换）

**禁止的动画类型：**
- ❌ `ColorAnimation`（颜色过渡，使用 Trigger Setter 替代）

### 3.2 新增控件的主题兼容清单

开发新控件时，必须完成以下清单：

#### 3.2.1 设计阶段

- [ ] 确定控件需要的颜色状态（Normal、Hover、Pressed、Disabled、Focused 等）
- [ ] 确定是否需要语义色（Success、Warning、Error、Info）
- [ ] 评估控件在不同主题下的视觉效果

#### 3.2.2 实现阶段

- [ ] 在 `Base/SemanticTokens.xaml` 中添加新的语义令牌
- [ ] 在 `Base/ComponentBrushes.xaml` 中添加对应的画刷
- [ ] 在所有其他主题的 `SemanticTokens.xaml` 中定义该令牌
- [ ] 在控件样式中使用 `{DynamicResource}` 引用画刷
- [ ] 测试主题切换时控件是否正确更新

#### 3.2.3 验证阶段

- [ ] 在所有 11 个主题下验证控件外观
- [ ] 验证控件的所有交互状态
- [ ] 验证主题切换动画流畅性
- [ ] 验证无视觉错误或颜色冲突

### 3.3 主题验证工具

#### 3.3.1 ThemeManager 验证方法

```csharp
// 调用验证方法获取主题应用状态报告
var report = ThemeManager.ValidateThemeApplication();
Debug.WriteLine(report);
```

**输出示例：**

```
=== 主题应用验证 ===
当前主题: Dark
当前主题字典: True

Application.Resources:
  - MergedDictionaries 数量: 5
  - 主题字典: pack://application:,,,/Lemoo.UI;component/Themes/Dark/Dark.xaml

关键颜色资源:
  ✓ workbench.background: #1E1E1E
  ✓ text.primary: #E0E0E0
  ✓ Palette.Accent.Primary: #007ACC

关键画刷资源:
  ✓ WorkbenchBackgroundBrush: #1E1E1E
  ✓ TextPrimaryBrush: #E0E0E0
  ✓ AccentPrimaryBrush: #007ACC
=== 验证完成 ===
```

#### 3.3.2 主题完整性检查脚本

```csharp
/// <summary>
/// 检查所有主题的语义令牌完整性
/// </summary>
public static Dictionary<string, List<string>> CheckThemeCompleteness()
{
    var requiredTokens = new[]
    {
        "workbench.background", "workbench.surface", "workbench.card",
        "titleBar.background", "titleBar.foreground",
        "sidebar.background", "sidebar.foreground",
        "button.background", "button.foreground",
        "input.background", "input.foreground", "input.border",
        "card.background", "card.border",
        "text.primary", "text.secondary",
        "border.default", "border.focus"
        // ... 添加所有必需的令牌
    };

    var themes = new[] { "Base", "Dark", "Light", "NeonCyberpunk", /* ... */ };
    var result = new Dictionary<string, List<string>>();

    foreach (var theme in themes)
    {
        var uri = new Uri($"pack://application:,,,/Lemoo.UI;component/Themes/{theme}/{theme}.xaml");
        var dict = new ResourceDictionary { Source = uri };
        var missing = new List<string>();

        foreach (var token in requiredTokens)
        {
            if (!dict.Contains(token))
            {
                missing.Add(token);
            }
        }

        if (missing.Count > 0)
        {
            result[theme] = missing;
        }
    }

    return result;
}
```

---

## 四、最佳实践与常见问题

### 4.1 最佳实践

#### 4.1.1 颜色选取

- **对比度**：确保文本与背景的对比度至少为 4.5:1（WCAG AA 标准）
- **语义一致性**：成功色偏绿、警告色偏黄、错误色偏红
- **主题风格**：保持主题的特色（如 NeonCyberpunk 使用高饱和霓虹色）

#### 4.1.2 渐变色处理

如果需要使用渐变色，定义完整的渐变色令牌：

```xml
<!-- 在 SemanticTokens.xaml 中 -->
<LinearGradientBrush x:Key="button.primaryGradient" StartPoint="0,0" EndPoint="1,0">
    <GradientStop Color="{DynamicResource Palette.Accent.Primary}" Offset="0"/>
    <GradientStop Color="{DynamicResource Palette.Accent.Secondary}" Offset="1"/>
</LinearGradientBrush>
```

#### 4.1.3 透明度处理

```xml
<!-- 定义带透明度的颜色 -->
<Color x:Key="overlay.background">#80000000</Color>  <!-- 50% 透明黑色 -->

<!-- 或者使用画刷的 Opacity -->
<SolidColorBrush x:Key="OverlayBrush" Color="{DynamicResource overlay.background}"/>
```

### 4.2 常见问题与解决方案

#### 4.2.1 问题：主题切换后某些控件颜色不变

**原因：**
1. 使用了 `StaticResource` 而非 `DynamicResource`
2. 使用了 `ColorAnimation` 硬编码颜色值
3. 画刷定义中使用了 `Color="{StaticResource ...}"`

**解决方案：**
```xml
<!-- 错误 -->
<SolidColorBrush x:Key="MyBrush" Color="{StaticResource button.background}"/>

<!-- 正确 -->
<SolidColorBrush x:Key="MyBrush" Color="{DynamicResource button.background}"/>
```

#### 4.2.2 问题：新主题缺少某些语义令牌

**原因：**
新增语义令牌后，未在所有主题中定义。

**解决方案：**
使用主题完整性检查脚本自动检测缺失的令牌。

#### 4.2.3 问题：主题切换时界面闪烁

**原因：**
1. 同步刷新导致 UI 阻塞
2. 过度触发属性失效

**解决方案：**
ThemeManager 已实现异步批量刷新，确保使用最新版本。

---

## 五、主题开发工作流

### 5.1 新增主题流程

```
1. 创建主题目录
   └── Themes/NewTheme/

2. 创建 ColorPalette.xaml（可选）
   └── 定义主题的基础调色板

3. 创建 SemanticTokens.xaml（必须）
   └── 定义所有必需的语义令牌

4. 创建 ComponentBrushes.xaml（可选）
   └── 如果有自定义画刷需求

5. 创建 NewTheme.xaml（主题入口）
   └── MergedDictionaries 引用上述文件

6. 在 ThemeManager.cs 中注册
   └── 添加 Theme 枚举值
   └── 添加主题 URI 常量
   └── 在 ApplyTheme switch 中添加分支
   └── 在 AvailableThemes 中添加 ThemeInfo

7. 测试验证
   └── 所有控件样式验证
   └── 主题切换测试
   └── 对比度检查
```

### 5.2 新增控件流程

```
1. 设计阶段
   └── 确定颜色需求和交互状态

2. 定义语义令牌
   └── 在 Base/SemanticTokens.xaml 中定义
   └── 在所有其他主题中定义

3. 定义组件画刷
   └── 在 Base/ComponentBrushes.xaml 中定义

4. 创建控件样式
   └── 使用 DynamicResource 引用画刷
   └── 使用 Trigger Setter 处理状态变化

5. 测试验证
   └── 在所有主题下验证
   └── 测试主题切换
```

---

## 六、附录

### 6.1 主题系统文件速查表

| 文件路径 | 用途 | 修改频率 |
|----------|------|----------|
| `Helpers/ThemeManager.cs` | 主题管理器 | 新增主题时 |
| `Themes/Base/SemanticTokens.xaml` | 基础语义令牌 | 新增控件时 |
| `Themes/Base/ComponentBrushes.xaml` | 基础组件画刷 | 新增控件时 |
| `Themes/[Theme]/SemanticTokens.xaml` | 主题语义令牌 | 新增控件/主题时 |
| `Styles/Win11/Win11.[Control].xaml` | 控件样式 | 控件样式调整时 |
| `Styles/CommonStyles.xaml` | 样式系统入口 | 新增控件时 |

### 6.2 关键代码位置

- **主题切换逻辑**: `ThemeManager.cs:370-502`
- **资源字典缓存**: `ThemeManager.cs:105`
- **异步窗口刷新**: `ThemeManager.cs:752-774`
- **样式系统入口**: `CommonStyles.xaml:9-22`

### 6.3 参考资源

- [WPF 资源字典最佳实践](https://docs.microsoft.com/en-us/dotnet/desktop/wpf/advanced/merged-resource-dictionaries)
- [VS Code 主题文档](https://code.visualstudio.com/api/extension-capabilities/theming)
- [WCAG 颜色对比度标准](https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html)

---

**文档版本**: 1.0.0
**最后更新**: 2026-01-19
**维护者**: Lemoo.UI Team
