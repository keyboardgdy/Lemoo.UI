# 架构决策记录 (ADR) 模板

本文档为 Lemoo.UI 项目提供架构决策记录 (Architecture Decision Record) 模板，用于记录重要的架构决策。

---

## ADR-001: 使用规格模式 (Specification Pattern)

### 状态
已接受 / 已弃用 / 已取代

### 日期
2026-01-14

### 背景
在项目开发过程中，我们发现查询逻辑分散在各个服务和仓储中，存在以下问题：
1. 复杂查询条件难以复用
2. 查询逻辑与业务逻辑耦合
3. 无法动态组合查询条件
4. 测试和维护困难

### 决策
引入规格模式 (Specification Pattern) 来封装查询逻辑。

### 理由
**优势：**
- ✅ 查询逻辑可复用
- ✅ 支持条件组合 (AND、OR、NOT)
- ✅ 符合开闭原则
- ✅ 易于单元测试
- ✅ 查询逻辑集中管理

**劣势：**
- ⚠️ 增加了一些类的数量
- ⚠️ 需要额外的学习成本

### 后果
- 仓储接口需要扩展以支持规格模式
- 所有复杂查询应使用规格实现
- 简单查询（如按ID查询）可以保留原有方法

### 实施
- [ ] 创建规格基类和组合规格
- [ ] 扩展仓储接口
- [ ] 迁移现有查询到规格模式
- [ ] 编写单元测试

### 参考资料
- [Martin Fowler - Specification Pattern](https://www.martinfowler.com/apsupp/spec/)
- [Microsoft - Specification Pattern](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/specification)

---

## ADR-002: 使用领域事件处理

### 状态
提议中

### 日期
2026-01-14

### 背景
当前项目中，聚合根的领域事件已定义但缺乏处理机制：
1. 领域事件没有自动分发
2. 缺乏事件处理器框架
3. 副作用直接写在业务逻辑中

### 决策
实现完整的领域事件处理机制。

### 理由
**优势：**
- ✅ 解耦聚合和副作用
- ✅ 支持多个处理器
- ✅ 便于审计和追踪
- ✅ 支持异步处理

**劣势：**
- ⚠️ 增加系统复杂度
- ⚠️ 需要处理失败重试

### 后果
- 在 UnitOfWork 中集成事件分发
- 所有副作用应通过事件处理器实现
- 需要考虑事务一致性

### 实施
- [ ] 创建事件处理器接口
- [ ] 实现事件调度器
- [ ] 集成到 UnitOfWork
- [ ] 编写集成测试

### 参考资料
- [Microsoft - Domain Events](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/domain-events)

---

## ADR-003: 软删除策略

### 状态
提议中

### 日期
2026-01-14

### 背景
数据删除在业务场景中需要保留记录：
1. 审计要求
2. 数据恢复需求
3. 关联数据完整性

### 决策
对所有实体实施软删除策略。

### 理由
**优势：**
- ✅ 数据可恢复
- ✅ 满足审计要求
- ✅ 保持关联完整性

**劣势：**
- ⚠️ 查询需要过滤已删除数据
- ⚠️ 存储空间增加

### 后果
- EntityBase 添加软删除字段
- 全局查询过滤器
- 仓储方法改为软删除
- 保留硬删除选项用于维护

### 实施
- [ ] 更新实体基类
- [ ] 配置全局查询过滤器
- [ ] 更新仓储删除方法
- [ ] 添加恢复操作

### 参考资料
- [EF Core - Query Filters](https://docs.microsoft.com/en-us/ef/core/querying/filters)

---

## ADR-004: 性能监控策略

### 状态
提议中

### 日期
2026-01-14

### 背景
生产环境需要监控应用性能：
1. 识别慢查询和慢请求
2. 资源使用监控
3. 错误追踪

### 决策
集成 OpenTelemetry 和 Prometheus 进行性能监控。

### 理由
**优势：**
- ✅ 标准化监控方案
- ✅ 与 Grafana 集成
- ✅ 支持分布式追踪
- ✅ 社区支持良好

### 后果
- 添加 OpenTelemetry 依赖
- 配置 Prometheus 导出器
- 定义关键指标
- 建立告警规则

### 实施
- [ ] 添加 OpenTelemetry 包
- [ ] 配置指标收集
- [ ] 集成 Prometheus
- [ ] 配置 Grafana 仪表板

### 参考资料
- [OpenTelemetry .NET](https://opentelemetry.io/docs/instrumentation/net/)
- [Prometheus .NET Client](https://github.com/prometheus/client_net)

---

## 使用指南

### 创建新的 ADR

1. 复制此模板
2. 更新编号（递增）
3. 填写各部分内容
4. 提交到版本控制

### ADR 状态

- **提议中** - 正在讨论的决策
- **已接受** - 已批准并实施
- **已弃用** - 仍有效但不推荐用于新情况
- **已取代** - 被新 ADR 取代

### ADR 结构

每个 ADR 应包含：
1. **状态** - 当前决策状态
2. **日期** - 决策日期
3. **背景** - 决策的背景和上下文
4. **决策** - 采取的决策
5. **理由** - 支持决策的原因和权衡
6. **后果** - 决策带来的影响
7. **实施** - 实施步骤和清单
8. **参考资料** - 相关链接和文档

---

## 已有决策索引

| ADR | 标题 | 状态 | 日期 |
|-----|------|------|------|
| ADR-001 | 规格模式 | 已接受 | 2026-01-14 |
| ADR-002 | 领域事件处理 | 提议中 | 2026-01-14 |
| ADR-003 | 软删除策略 | 提议中 | 2026-01-14 |
| ADR-004 | 性能监控策略 | 提议中 | 2026-01-14 |
