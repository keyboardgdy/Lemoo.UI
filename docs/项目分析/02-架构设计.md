# Lemoo.UI 架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           表现层 (Presentation)                      │
├─────────────────────────────────────┬───────────────────────────────┤
│         Lemoo.UI.WPF               │          Lemoo.Api            │
│         (WPF 桌面应用)              │        (Web API 服务)          │
├─────────────────────────────────────┴───────────────────────────────┤
│                        UI 共享层 (UI Shared)                        │
│              Lemoo.UI.Shared + Lemoo.UI (控件库)                    │
├─────────────────────────────────────────────────────────────────────┤
│                        宿主层 (Hosts)                               │
│           Lemoo.Host (WPF宿主)  │  Lemoo.Api (API宿主)             │
├─────────────────────────────────────────────────────────────────────┤
│                      启动引导层 (Bootstrap)                         │
│                      Lemoo.Bootstrap                                │
├─────────────────────────────────────────────────────────────────────┤
│                        模块层 (Modules)                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Lemoo.Modules.Abstractions (模块抽象层)                    │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  TaskManager (示例模块)  │  [其他业务模块...]               │   │
│  └─────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────┤
│                        核心层 (Core)                                 │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐     │
│  │ Abstractions │   Domain    │ Application  │Infrastructure│     │
│  │  (接口定义)   │  (领域核心)  │  (应用核心)   │  (基础设施)   │     │
│  └──────────────┴──────────────┴──────────────┴──────────────┘     │
│                    Lemoo.Core.Common (通用能力)                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 分层架构说明

### 1. 核心层 (Core Layer)

核心层是整个框架的基础，提供架构所需的核心抽象和实现。

#### 1.1 核心抽象层 (Lemoo.Core.Abstractions)

定义整个框架的核心接口和契约：

```
Lemoo.Core.Abstractions/
├── CQRS/                    # CQRS 模式接口
│   ├── ICommand.cs          # 命令接口
│   ├── IQuery.cs            # 查询接口
│   ├── ICommandHandler.cs   # 命令处理器接口
│   └── IQueryHandler.cs     # 查询处理器接口
├── Domain/                  # 领域接口
│   ├── IEntity.cs           # 实体接口
│   ├── IAggregateRoot.cs    # 聚合根接口
│   ├── IDomainEvent.cs      # 领域事件接口
│   └── IRepository.cs       # 仓储接口
├── Module/                  # 模块接口
│   ├── IModule.cs           # 模块接口
│   └── IModuleLoader.cs     # 模块加载器接口
├── Persistence/             # 持久化接口
│   ├── IUnitOfWork.cs       # 工作单元接口
│   └── IModuleDbContextFactory.cs
├── UI/                      # UI 接口
│   ├── IModuleUI.cs         # 模块 UI 接口
│   └── IPageRegistry.cs     # 页面注册接口
└── Services/                # 服务接口
    ├── ICacheService.cs
    ├── IFileService.cs
    └── IBackgroundJobService.cs
```

**设计原则**:
- 接口隔离原则 (ISP)
- 依赖倒置原则 (DIP)
- 无依赖其他 Lemoo 项目

#### 1.2 核心领域层 (Lemoo.Core.Domain)

提供领域模型的基类实现：

```
Lemoo.Core.Domain/
├── BaseEntity.cs              # 实体基类
│   └── EntityBase<TKey>       # 泛型实体基类
├── AggregateRoot.cs           # 聚合根基类
│   └── AggregateRoot<TKey>    # 泛型聚合根基类
├── ValueObjectBase.cs         # 值对象基类
└── DomainEventBase.cs         # 领域事件基类
```

**核心类说明**:

| 类名 | 职责 | 特性 |
|------|------|------|
| EntityBase<TKey> | 通用实体基类 | Id, CreatedAt, UpdatedAt, CreatedBy, UpdatedBy |
| AggregateRoot<TKey> | 聚合根基类 | 领域事件管理 |
| ValueObjectBase | 值对象基类 | 基于值的相等性比较 |
| DomainEventBase | 领域事件基类 | 事件元数据 |

#### 1.3 核心应用层 (Lemoo.Core.Application)

实现 CQRS 模式和横切关注点：

```
Lemoo.Core.Application/
├── Common/                    # 通用组件
│   ├── Result.cs              # 结果模式
│   └── PerformanceMetrics.cs  # 性能指标
├── Behaviors/                 # 管道行为
│   ├── ValidationBehavior.cs  # 验证行为
│   ├── LoggingBehavior.cs     # 日志行为
│   ├── CacheBehavior.cs       # 缓存行为
│   └── TransactionBehavior.cs # 事务行为
├── Attributes/                # 特性
│   └── CacheAttribute.cs      # 缓存特性
└── Extensions/                # 扩展方法
    ├── CommandExtensions.cs
    └── ServiceCollectionExtensions.cs
```

**CQRS 管道流程**:
```
Request
  ↓
ValidationBehavior (自动验证)
  ↓
CacheBehavior (查询缓存)
  ↓
TransactionBehavior (命令事务)
  ↓
LoggingBehavior (日志记录)
  ↓
Handler (业务处理)
  ↓
Response
```

#### 1.4 核心基础设施层 (Lemoo.Core.Infrastructure)

提供核心接口的具体实现：

```
Lemoo.Core.Infrastructure/
├── ModuleLoader/              # 模块加载器
│   └── ModuleLoader.cs
├── Caching/                   # 缓存实现
│   ├── MemoryCacheService.cs
│   └── RedisCacheService.cs
├── Persistence/               # 持久化实现
│   ├── UnitOfWork.cs
│   ├── Repository.cs
│   └── ReadOnlyRepository.cs
├── Logging/                   # 日志实现
│   ├── SerilogConfiguration.cs
│   └── LoggerService.cs
├── Messaging/                 # 消息队列
│   ├── InMemoryMessageBus.cs
│   └── RabbitMqMessageBus.cs
├── BackgroundJobs/            # 后台任务
│   └── HangfireJobService.cs
└── FileStorage/               # 文件存储
    └── LocalFileService.cs
```

### 2. 模块层 (Modules Layer)

模块层是业务功能的实现层，每个模块遵循 DDD + CQRS 架构。

#### 2.1 模块抽象层 (Lemoo.Modules.Abstractions)

```
Lemoo.Modules.Abstractions/
└── ModuleBase.cs              # 模块基类
```

**ModuleBase 生命周期**:
```
PreConfigureServices
  ↓
ConfigureServices
  ↓
PostConfigureServices
  ↓
ConfigureDbContext
  ↓
OnApplicationStartingAsync
  ↓
OnApplicationStartedAsync
  ↓
[应用运行中]
  ↓
OnApplicationStoppingAsync
  ↓
OnApplicationStoppedAsync
```

#### 2.2 模块结构 (以 TaskManager 为例)

```
TaskManager/
├── Domain/                    # 领域层
│   ├── Entities/
│   │   └── Task.cs           # 聚合根
│   ├── ValueObjects/
│   │   ├── TaskStatus.cs
│   │   └── TaskPriority.cs
│   └── DomainEvents/
│       └── TaskCreatedEvent.cs
├── Application/               # 应用层
│   ├── Commands/
│   │   ├── CreateTaskCommand.cs
│   │   └── UpdateTaskCommand.cs
│   ├── Queries/
│   │   ├── GetTaskQuery.cs
│   │   └── GetAllTasksQuery.cs
│   ├── Handlers/
│   │   └── CreateTaskCommandHandler.cs
│   ├── DTOs/
│   │   └── TaskDto.cs
│   └── Validators/
│       └── CreateTaskCommandValidator.cs
├── Infrastructure/            # 基础设施层
│   ├── Persistence/
│   │   ├── TaskManagerDbContext.cs
│   │   └── Configurations/
│   │       └── TaskConfiguration.cs
│   └── Repositories/
│       └── TaskRepository.cs
├── TaskManagerModule.cs      # 模块入口
└── TaskManager.Module.csproj
```

### 3. 启动引导层 (Bootstrap Layer)

```
Lemoo.Bootstrap/
├── Bootstrapper.cs            # 启动引导器
├── IBootstrapper.cs           # 引导器接口
├── BootstrapResult.cs         # 引导结果
└── Extensions/
    └── HostBuilderExtensions.cs
```

**启动流程**:
```
1. 配置验证
   ↓
2. 环境检测
   ↓
3. 加载配置文件
   ↓
4. 发现模块
   ↓
5. 验证依赖关系
   ↓
6. 拓扑排序
   ↓
7. 注册核心服务
   ↓
8. 配置模块服务
   ↓
9. 启动模块
   ↓
10. 应用程序就绪
```

### 4. 宿主层 (Hosts Layer)

#### 4.1 WPF 宿主

```
Lemoo.Host/
├── App.xaml                  # WPF 应用入口
├── App.xaml.cs
├── MainWindow.xaml           # 主窗口
├── MainWindow.xaml.cs
└── Program.cs                # 程序入口点
```

#### 4.2 API 宿主

```
Lemoo.Api/
├── Program.cs                # API 入口
├── Startup.cs                # 启动配置
├── Controllers/
│   └── BaseController.cs     # 控制器基类
├── Middleware/
│   ├── GlobalExceptionHandlerMiddleware.cs
│   └── RequestIdMiddleware.cs
└── Properties/
    └── launchSettings.json
```

**API 中间件管道**:
```
Request
  ↓
RequestIdMiddleware (请求追踪)
  ↓
GlobalExceptionHandlerMiddleware (异常处理)
  ↓
CORS (跨域)
  ↓
Authorization (授权)
  ↓
Controllers (API 端点)
  ↓
Response
```

### 5. UI 层 (UI Layer)

```
UI/
├── Lemoo.UI.Shared/          # UI 共享组件
├── Lemoo.UI/                 # WPF 控件库
│   ├── Controls/
│   │   ├── MainTitleBar.xaml     # 标题栏
│   │   ├── Sidebar.xaml          # 侧边栏
│   │   └── DocumentTabHost.xaml  # 标签页容器
│   ├── Styles/
│   │   ├── CommonStyles.xaml
│   │   ├── Design/
│   │   │   ├── Typography.xaml
│   │   │   ├── Spacing.xaml
│   │   │   └── Shadows.xaml
│   │   └── Themes/
│   │       ├── Light/
│   │       └── Dark/
│   └── Converters/
└── Lemoo.UI.WPF/             # WPF 应用框架
    ├── Services/
    │   ├── PageRegistryService.cs
    │   └── NavigationService.cs
    └── ViewModels/
        └── MainViewModel.cs
```

## 设计模式应用

| 设计模式 | 应用位置 | 说明 |
|---------|---------|------|
| 分层架构 | 整个解决方案 | 职责分离、依赖方向控制 |
| DDD | 模块层 | 领域模型、聚合根、值对象 |
| CQRS | 应用层 | 命令查询分离 |
| 依赖注入 | 全局 | IoC 容器 |
| 仓储模式 | Infrastructure | 数据访问抽象 |
| 工作单元模式 | Infrastructure | 事务管理 |
| 中介者模式 | CQRS | MediatR |
| 管道模式 | Behaviors | 请求处理管道 |
| 装饰器模式 | Behaviors | 行为装饰 |
| 策略模式 | 缓存、消息 | 多种实现策略 |
| 工厂模式 | 模块加载 | 动态实例化 |
| 模板方法模式 | ModuleBase | 生命周期钩子 |
| 观察者模式 | 领域事件 | 事件驱动 |

## 依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                          宿主层                                  │
│  Lemoo.Host  ─────┐                                             │
│  Lemoo.Api   ─────┼──→  Lemoo.Bootstrap  ──────────────────┐   │
└───────────────────┘                                           │   │
                                                                 │   │
┌─────────────────────────────────────────────────────────────┐ │   │
│                        UI 层                                 │ │   │
│  Lemoo.UI.WPF  ───────────────────────────────────────────┼─┼───┘
│  Lemoo.UI        ─────────────────────────────────────────┼─┘
│  Lemoo.UI.Shared ─────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────┘
                                                                 │
┌─────────────────────────────────────────────────────────────┐ │
│                      模块层                                  │ │
│  TaskManager  ─────────────────────────────────────────────┼─┘
│    │                                                        │
│    └──→  Lemoo.Modules.Abstractions  ───────────────────────┘
└─────────────────────────────────────────────────────────────┘
                                                                 │
┌─────────────────────────────────────────────────────────────┐ │
│                      核心层                                  │ │
│  ┌──────────────────────────────────────────────────────┐  │ │
│  │  Infrastructure  →  Application  →  Domain          │  │ │
│  │       ↓                    ↓            ↓             │  │ │
│  │  Abstractions ←───────────────────────────────────────│──┘ │
│  └──────────────────────────────────────────────────────┘     │
│            ↑                                                   │
│  Common ──┴───────────────────────────────────────────────────┘
└───────────────────────────────────────────────────────────────┘
```
